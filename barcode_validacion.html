<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Validar Código de Barras</title>
  <style>body{font-family:Arial;margin:16px}.section{border:1px solid #ddd;padding:12px;border-radius:6px}.row{display:flex;gap:8px;align-items:center}</style>
</head>
<body>
  <h2>Escanear Código de Barras y confirmar</h2>
  <div class="section">
    <p>Se abrirá la cámara para detectar un código de barras. Al detectarlo se redirigirá automáticamente a la página de resultado.</p>
    <div id="barcode-reader" style="width:320px;height:240px;background:#000"></div>
    <p>Resultado: <strong id="detected">(esperando)</strong></p>
    <div class="row">
      <button id="btn-stop">Detener cámara</button>
    </div>
    <p class="note">Al detectar un código el navegador irá a <code>result.html?type=barcode&value=&lt;valor&gt;</code>.</p>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script>
    const detectedEl = document.getElementById('detected');
    const formValue = document.getElementById('form-value');
    const btnConfirm = document.getElementById('btn-confirm');
    const btnStop = document.getElementById('btn-stop');

    function startQuagga(){
      Quagga.init({
        inputStream: { name: 'Live', type: 'LiveStream', target: document.querySelector('#barcode-reader'), constraints: { facingMode: 'environment' } },
        decoder: { readers: ['code_128_reader','ean_reader','ean_8_reader','upc_reader'] }
      }, function(err){
        if(err){ detectedEl.textContent = 'Quagga init error: '+err; return; }
        Quagga.start();
      });
      Quagga.onDetected(data=>{
        if(data && data.codeResult && data.codeResult.code){
            const code = data.codeResult.code;
            detectedEl.textContent = code;
            try{ Quagga.stop(); }catch(e){}
            // redirigir al resultado
            const target = 'result.html?type=barcode&value=' + encodeURIComponent(code);
            window.location.href = target;
          }
      });
    }

    startQuagga();
    btnStop.addEventListener('click', ()=>{ Quagga.stop(); detectedEl.textContent='(detenido)'; });
  </script>
</body>
</html>