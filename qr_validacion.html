<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Validar QR</title>
  <style>body{font-family:Arial;margin:16px}.section{border:1px solid #ddd;padding:12px;border-radius:6px}.row{display:flex;gap:8px;align-items:center}</style>
</head>
<body>
  <h2>Escanear QR y confirmar</h2>
  <div class="section">
    <p>Se abrirá la cámara para detectar un QR. Al detectarlo se redirigirá automáticamente a la página de resultado.</p>
    <div id="qr-reader" style="width:320px;height:240px;background:#000"></div>
    <p>Resultado: <strong id="detected">(esperando)</strong></p>
    <div class="row">
      <button id="btn-stop">Detener cámara</button>
    </div>
    <p class="note">Al detectar un QR el navegador irá a <code>result.html?type=qr&value=&lt;valor&gt;</code>.</p>
  </div>

  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
  <script>
    const qrReaderId = 'qr-reader';
    const html5QrCode = new Html5Qrcode(qrReaderId);
    const detectedEl = document.getElementById('detected');
    const formValue = document.getElementById('form-value');
    const btnConfirm = document.getElementById('btn-confirm');
    const btnStop = document.getElementById('btn-stop');

    function onScanSuccess(decodedText, decodedResult){
      // se detectó QR — redirigir al resultado
      detectedEl.textContent = decodedText;
      try{ html5QrCode.stop(); }catch(e){}
      const target = 'result.html?type=qr&value=' + encodeURIComponent(decodedText);
      window.location.href = target;
    }
    function onScanFailure(error){ /* no-op */ }

    // iniciar scanner
    Html5Qrcode.getCameras().then(cameras=>{
      const cameraId = cameras && cameras.length ? cameras[0].id : null;
      html5QrCode.start({ deviceId: { exact: cameraId } }, { fps:10, qrbox:250 }, onScanSuccess, onScanFailure)
      .catch(err=>{ detectedEl.textContent = 'Error al iniciar cámara: '+err; });
    }).catch(err=>{ detectedEl.textContent = 'No se encontraron cámaras: '+err; });

    btnStop.addEventListener('click', ()=>{
      html5QrCode.stop().then(()=>{ detectedEl.textContent='(detenido)'; }).catch(e=>console.warn(e));
    });
  </script>
</body>
</html>