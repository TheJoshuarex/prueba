<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Demo QR / Barcode / Biometría</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:18px}
    h1{font-size:1.2rem}
    .section{border:1px solid #ddd;padding:12px;margin:12px 0;border-radius:6px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input,button,select{padding:6px;font-size:0.95rem}
    #qrcode, #barcode { margin-top:10px }
    #qr-reader, #barcode-reader{width:320px;height:240px;background:#000}
    pre{background:#f6f8fa;padding:8px;border-radius:6px}
    .note{color:#555;font-size:0.9rem}
  </style>
</head>
<body>
  <h1>Versión con QR, Código de Barras y Demo biométrico</h1>

  <div class="section">
    <strong>Generar QR</strong>
    <div class="row">
      <input id="qr-text" placeholder="Texto a convertir en QR" style="min-width:280px" />
      <button id="btn-gen-qr">Generar QR</button>
      <button id="btn-download-qr">Descargar PNG</button>
    </div>
    <div id="qrcode"></div>
  </div>

  <div class="section">
    <strong>Generar Código de Barras (CODE128)</strong>
    <div class="row">
      <input id="barcode-text" placeholder="Texto o números" style="min-width:280px" />
      <button id="btn-gen-barcode">Generar Código</button>
      <button id="btn-download-barcode">Descargar SVG</button>
    </div>
    <svg id="barcode" />
  </div>

  <div class="section">
    <strong>Validación (enlace generado)</strong>
    <div class="row">
      <p class="note">Al generar un QR se mostrará el enlace de validación automáticamente.</p>
    </div>
  </div>

  <div class="section">
    <strong>Validación (enlace generado)</strong>
    <div class="row">
      <p class="note">Al generar un código de barras se mostrará el enlace de validación automáticamente.</p>
    </div>
  </div>

    <div class="section">
    <strong>Demo Biometría (WebAuthn) — registro y verificación local</strong>
    <div class="row">
      <input id="webauthn-username" placeholder="Usuario (ej: juan)" />
      <button id="btn-webauthn-register">Registrar (create)</button>
      <button id="btn-webauthn-auth">Autenticar (get)</button>
      <a href="huella.html" target="_blank"><button>Detección huella (tiempo real)</button></a>
    </div>
    <p class="note">Este es un demo cliente-only que utiliza el autenticador de la plataforma (p. ej. huella del dispositivo). Para detectar huella en "tiempo real" abre la página dedicada.</p>
    <pre id="webauthn-log">(logs)</pre>
  </div>

  <div class="section">
    <strong>Instrucciones rápidas</strong>
    <ul>
      <li>Coloca este archivo en `c:\xampp\htdocs\hero\heroes_biometric.html` y ábrelo en el navegador usando <code>http://localhost/hero/heroes_biometric.html</code>.</li>
      <li>El demo WebAuthn funciona en `localhost` (contexto seguro) y puede solicitar huella si el navegador/soporte de plataforma lo permite.</li>
      <li>Para integración real de un escáner de huella USB dev/proveedor, necesitas su SDK y endpoints server-side.</li>
    </ul>
  </div>

  <!-- Librerías CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <!-- No se cargan librerías de escaneo aquí; la validación se realiza vía `result.html` -->

  <script>
    // ------------------ Helpers ------------------
    function arrayBufferToBase64(buffer){
      const bytes = new Uint8Array(buffer);
      let binary = '';
      for(let i=0;i<bytes.byteLength;i++) binary += String.fromCharCode(bytes[i]);
      return window.btoa(binary);
    }
    function base64ToArrayBuffer(base64){
      const binary = window.atob(base64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for(let i=0;i<len;i++) bytes[i] = binary.charCodeAt(i);
      return bytes.buffer;
    }
    function toBase64Url(buffer){
      return arrayBufferToBase64(buffer).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }
    function fromBase64Url(base64url){
      base64url = base64url.replace(/-/g,'+').replace(/_/g,'/');
      // pad
      while(base64url.length % 4) base64url += '=';
      return base64ToArrayBuffer(base64url);
    }

    // ------------------ QR generation ------------------
    let qrInstance = null;
    document.getElementById('btn-gen-qr').addEventListener('click', ()=>{
      const txt = document.getElementById('qr-text').value || 'Demo QR';
      const container = document.getElementById('qrcode');
      container.innerHTML = '';
      qrInstance = new QRCode(container, {text:txt, width:200, height:200});
    });

    document.getElementById('btn-download-qr').addEventListener('click', ()=>{
      const container = document.querySelector('#qrcode img, #qrcode canvas');
      if(!container){ alert('Genere primero el QR'); return; }
      if(container.tagName.toLowerCase() === 'img'){
        const a = document.createElement('a'); a.href = container.src; a.download = 'qrcode.png'; a.click();
      } else {
        const data = container.toDataURL('image/png');
        const a = document.createElement('a'); a.href = data; a.download = 'qrcode.png'; a.click();
      }
    });

    // ------------------ Barcode generation ------------------
    document.getElementById('btn-gen-barcode').addEventListener('click', ()=>{
      const txt = document.getElementById('barcode-text').value || '1234567890';
      const svg = document.getElementById('barcode');
      JsBarcode(svg, txt, {format:'CODE128', displayValue:true, width:2, height:60});
    });
    document.getElementById('btn-download-barcode').addEventListener('click', ()=>{
      const svg = document.getElementById('barcode');
      const serializer = new XMLSerializer();
      const svgStr = serializer.serializeToString(svg);
      const blob = new Blob([svgStr], {type:'image/svg+xml'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'barcode.svg'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url),1000);
    });

    // ------------------ Generación de enlaces de validación ------------------
    function createOrUpdateLink(container, id, target){
      let linkDiv = document.getElementById(id);
      if(!linkDiv){
        linkDiv = document.createElement('div');
        linkDiv.id = id;
        linkDiv.className = 'note';
        container.parentNode.insertBefore(linkDiv, container.nextSibling);
      }
      const safeTarget = target;
      linkDiv.innerHTML = `Enlace de validación: <a href="${safeTarget}" target="_blank">${safeTarget}</a> `;
      // añadir botones abrir y copiar
      const btnOpen = document.createElement('button'); btnOpen.textContent = 'Abrir';
      btnOpen.addEventListener('click', ()=> window.open(safeTarget, '_blank'));
      const btnCopy = document.createElement('button'); btnCopy.textContent = 'Copiar';
      btnCopy.addEventListener('click', ()=>{
        navigator.clipboard.writeText(safeTarget).then(()=>{ alert('Enlace copiado al portapapeles'); }).catch(()=>{ alert('No se pudo copiar automáticamente. Selecciona y copia manualmente.'); });
      });
      // limpiar posibles botones previos
      // eliminar children que sean botones (evitar duplicados)
      Array.from(linkDiv.querySelectorAll('button')).forEach(b=>b.remove());
      linkDiv.appendChild(btnOpen); linkDiv.appendChild(btnCopy);
    }

    // modificar eventos de generación para crear el enlace automáticamente
    document.getElementById('btn-gen-qr').addEventListener('click', ()=>{
      const txt = document.getElementById('qr-text').value || 'Demo QR';
      const container = document.getElementById('qrcode');
      container.innerHTML = '';
      qrInstance = new QRCode(container, {text:txt, width:200, height:200});
      const target = 'result.html?type=qr&value=' + encodeURIComponent(txt);
      createOrUpdateLink(container, 'qr-link', target);
    });

    document.getElementById('btn-gen-barcode').addEventListener('click', ()=>{
      const txt = document.getElementById('barcode-text').value || '1234567890';
      const svg = document.getElementById('barcode');
      JsBarcode(svg, txt, {format:'CODE128', displayValue:true, width:2, height:60});
      const target = 'result.html?type=barcode&value=' + encodeURIComponent(txt);
      createOrUpdateLink(svg, 'barcode-link', target);
    });

    // ------------------ WebAuthn demo (cliente-only) ------------------
    const logEl = document.getElementById('webauthn-log');
    function log(msg){ logEl.textContent = new Date().toLocaleTimeString()+ ' - ' + msg + '\n' + logEl.textContent }

    function randomBuffer(len){ const b = new Uint8Array(len); window.crypto.getRandomValues(b); return b.buffer }

    document.getElementById('btn-webauthn-register').addEventListener('click', async ()=>{
      const username = document.getElementById('webauthn-username').value || 'user';
      try{
        const userId = new TextEncoder().encode(username + ':' + Math.floor(Math.random()*100000));
        const publicKey = {
          challenge: new Uint8Array(32),
          rp: { name: 'Demo RP' },
          user: { id: userId, name: username, displayName: username },
          pubKeyCredParams: [ { type: 'public-key', alg: -7 } ],
          authenticatorSelection: { authenticatorAttachment: 'platform', userVerification: 'preferred' },
          timeout: 60000,
          attestation: 'none'
        };
        window.crypto.getRandomValues(publicKey.challenge);
        const credential = await navigator.credentials.create({ publicKey });
        if(!credential){ log('Registro cancelado o falló'); return; }
        const rawId = credential.rawId;
        const idB64 = toBase64Url(rawId);
        // Guardamos en localStorage (demo solo cliente)
        localStorage.setItem('webauthn_cred_id', idB64);
        log('Registrado. id guardado en localStorage');
      }catch(e){ log('Error en register: '+e); }
    });

    document.getElementById('btn-webauthn-auth').addEventListener('click', async ()=>{
      const idB64 = localStorage.getItem('webauthn_cred_id');
      if(!idB64){ log('No hay credential guardada. Registra primero.'); return; }
      try{
        const allowId = new Uint8Array(fromBase64Url(idB64));
        const publicKey = {
          challenge: new Uint8Array(32),
          allowCredentials: [{ id: allowId, type: 'public-key', transports: ['internal'] }],
          userVerification: 'preferred',
          timeout: 60000
        };
        window.crypto.getRandomValues(publicKey.challenge);
        const assertion = await navigator.credentials.get({ publicKey });
        if(!assertion){ log('Autenticación cancelada o falló'); return; }
        log('Autenticación OK (respuesta recibida).');
      }catch(e){ log('Error en auth: '+e); }
    });

  </script>
</body>
</html>